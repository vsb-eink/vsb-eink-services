name: Publish docker images

on:
  workflow_dispatch:
  push:
    paths:
      - package.json
      - apps/**/package.json
      - services/**/package.json

jobs:
  build-and-push:
    strategy:
      matrix:
        include:
          - package-name: dashboard-vue
            package-path: apps/dashboard-vue
          - package-name: compressor
            package-path: services/compressor
          - package-name: facade
            package-path: services/facade
          - package-name: grouper
            package-path: services/grouper
          - package-name: hoster
            package-path: services/hoster
          - package-name: renderer
            package-path: services/renderer
          - package-name: scheduler
            package-path: services/scheduler
    runs-on: [ubuntu-latest]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if package version has changed
        id: check-version
        if: ${{ github.event_name == 'push' }}
        uses: EndBug/version-check@v2
        with:
          diff-search: true
          file-name: ${{ matrix.package-path }}/package.json

      - name: Override package version check for manual workflow dispatch
        id: manual-version-override
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: > 
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "version=${{ format('{0}/package.json', fromJSON(matrix.package-path).version) }}" >> "$GITHUB_OUTPUT"

      - name: Login to Github Registry
        if: steps.check-version.outputs.changed == 'true' || steps.manual-version-override.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        if: steps.check-version.outputs.changed == 'true' || steps.manual-version-override.outputs.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          target: ${{ matrix.package-name }}
          tags: vsb-eink/${{ matrix.package-name }}:latest,vsb-eink/${{ matrix.package-name }}:${{ steps.check-version.outputs.version }}